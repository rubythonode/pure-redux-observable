<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>pure redux-observable</title>

        <script src="https://unpkg.com/redux@^3.5.2/dist/redux.min.js"></script>
        <script src="https://unpkg.com/@reactivex/rxjs@5.0.0-beta.12/dist/global/Rx.js"></script>
        <script src="https://unpkg.com/redux-observable/dist/redux-observable.min.js"></script>
    </head>
    <body>

        <script>
            console.log('Redux', Redux);
            console.log('ReduxObservable', ReduxObservable);
            
            var createStore          = Redux.createStore,
                applyMiddleware      = Redux.applyMiddleware,
                createEpicMiddleware = ReduxObservable.createEpicMiddleware;
            
            console.log('createStore\n\n',createStore);
            console.log('applyMiddleware\n\n', applyMiddleware);
            console.log('createEpicMiddleware\n\n', createEpicMiddleware);


            /*------- Actions ---------------------------------------------*/
            var GET_BOARDS         = '[Boards] GetBoards';
                GET_BOARDS_SUCCESS = '[Boards] GetBoardsSuccess';

            var GetBoards        = () => ({ type : GET_BOARDS });
                GetBoardsSuccess = (boards) => {
                    console.log('GetBoardsSuccess', boards);
                    return ({ type : GET_BOARDS_SUCCESS, ...boards })
                };


            /*------- Effects ---------------------------------------------*/
            var getBoards$ = (epic) => epic.ofType(GET_BOARDS)
                                            .delay(1000)
                                            .switchMap((action) => {
                                                return Rx.Observable.ajax({
                                                    url : 'http://127.0.0.1:5500/model/data.json',
                                                    method : 'GET',
                                                    crossDomain : true
                                                }).map(e => {
                                                    console.log('Ajax then', e.response);
                                                    return e.response
                                                }).catch(err => console.error(err));
                                            })
                                            .map(v => {
                                                console.log('Effects then', v);
                                                return GetBoardsSuccess(v)
                                            });


            /*------- Reducer ---------------------------------------------*/
            var initialState = {
                    pending: false,
                    boards : []
                },
                newState = (state, newData) => Object.assign({}, state, newData);

            var boardsReducer = (state = initialState, action) => {
                console.log('action', action);

                switch (action.type) {
                    case GET_BOARDS:
                        return newState(state, { pending: true });
                    case GET_BOARDS_SUCCESS:
                        return newState(state, { pending: false, boards : action.boards });
                    default : state;
                }
            };


            /*------- App ---------------------------------------------*/
            var effects = createEpicMiddleware(getBoards$);
                store   = createStore(boardsReducer, applyMiddleware(effects));
            
            store.subscribe( ()=> console.log('Subscribe then\n\n', store.getState(), '\n\n'));
            store.dispatch(GetBoards());

        </script>
    </body>
</html>